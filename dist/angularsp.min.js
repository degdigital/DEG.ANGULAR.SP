var app=app||angular.module("angularSP",["ui.bootstrap","ui.grid","ui.grid.selection"]);!function(e,t){function n(e){function n(e,t,n,r){e.$watch("ngspColumn",function(){void 0!==e.ngspColumn&&(t.html(""),t.append(a(e.ngspColumn)),t.append(void 0!==e.ngspReadOnly&&e.ngspReadOnly?m(r,e):o(t,r,e)))})}function a(e){var n=t("<label></label>");return n.text(e.Title),n}function o(e,t,n){switch(n.ngspColumn.InputType){case"text":return r(t,n);case"textBox":return u(t,n);case"nicEdit":return i(t,n);case"dropDown":return l(t,n);case"radio":return p(t,n);case"checkbox":return s(t,n);case"dateTime":return c(t,n);case"peoplePicker":return d(e,t,n);default:console.log(n.ngspColumn.InputType+" is currently unsupported as an input type.")}}function r(n,a){void 0!==n.$viewValue&&(a.InputValue=n.$viewValue),n.$formatters.push(function(e){a.InputValue=e}),a.textInputChanged=function(){n.$setViewValue(a.InputValue)};var o=t("<input />");if(o.attr("data-ng-model","InputValue"),o.attr("data-ng-change","textInputChanged()"),"text"===a.ngspColumn.Type);else if("link"===a.ngspColumn.Type);else if("number"===a.ngspColumn.Type);else if("currency"!==a.ngspColumn.Type)return void console.log(a.ngspColumn.Type+"is not supported as a column type for text input.");return e(o)(a),o}function u(n,a){void 0!==n.$viewValue&&(a.InputValue=n.$viewValue),n.$formatters.push(function(e){a.InputValue=e}),a.textAreaChanged=function(){n.$setViewValue(a.InputValue)};var o=t("<textarea></textarea>");return o.attr("data-ng-model","InputValue"),o.attr("data-ng-change","textAreaChanged()"),"multiText"!==a.ngspColumn.Type?void console.log(a.ngspColumn.Type+"is not supported as a column type for text box."):(e(o)(a),o)}function i(n,a){void 0!==n.$viewValue&&(a.InputValue=n.$viewValue),n.$formatters.push(function(e){a.InputValue=e});var o=t("<span></span>"),r=t("<div></div>");o.append(r);var u=t("<div></div>");u.attr("contenteditable","true"),u.attr("data-ng-model","InputValue"),o.append(u);var i={iconsPath:"/AngularSP/lib/images/nicEditorIcons.gif"},l=new nicEditor(i);return l.setPanel(r[0]),l.addInstance(u[0]),"multiText"!==a.ngspColumn.Type?void console.log(a.ngspColumn.Type+"is not supported as a column type for nicEdit."):(e(o)(a),a.$watch("InputValue",function(){n.$setViewValue(a.InputValue)}),o)}function l(n,a){void 0!==n.$viewValue&&(a.InputValue=n.$viewValue),n.$formatters.push(function(e){a.InputValue=e}),a.dropDownChanged=function(){n.$setViewValue(a.InputValue)};var o=t("<select></select>");if(o.attr("data-ng-model","InputValue"),o.attr("data-ng-change","dropDownChanged()"),"choice"===a.ngspColumn.Type)o.attr("data-ng-options","choice for choice in ngspColumn.Choices");else if("lookup"===a.ngspColumn.Type)o.attr("data-ng-options","lookupItem.id as lookupItem.label for lookupItem in ngspColumn.LookupItems");else{if("metadata"!==a.ngspColumn.Type)return void console.log(a.ngspColumn.Type+"is not supported as a column type for dropdown menus.");o.attr("data-ng-options","term.id as term.label for term in ngspColumn.Terms")}return e(o)(a),o}function s(n,a){void 0!==n.$viewValue&&(a.InputValue=n.$viewValue),n.$formatters.push(function(e){a.InputValue=e}),a.checkboxChanged=function(){n.$setViewValue(a.InputValue)};var o=t("<span></span>");if("multiMetadata"===a.ngspColumn.Type||"multiLookup"===a.ngspColumn.Type||"multiChoice"===a.ngspColumn.Type){var r=t("<span></span>"),u=t("<input />");u.attr("data-ng-change","checkboxChanged()");var i=t("<label></label>");u.attr("type","checkbox"),"multiMetadata"===a.ngspColumn.Type?(r.attr("data-ng-repeat","term in ngspColumn.Terms"),u.attr("data-ng-model","InputValue[term.id]"),i.text("{{term.label}}")):"multiLookup"===a.ngspColumn.Type?(r.attr("data-ng-repeat","lookupItem in ngspColumn.LookupItems"),u.attr("data-ng-model","InputValue[lookupItem.id]"),i.text("{{lookupItem.label}}")):"multiChoice"===a.ngspColumn.Type&&(r.attr("data-ng-repeat","choice in ngspColumn.Choices"),u.attr("data-ng-model","InputValue[choice]"),i.text("{{choice}}")),r.append(u),r.append(i)}else{if("yesNo"!==a.ngspColumn.Type)return void console.log(a.ngspColumn.Type+"is not supported as a column type for checkboxes.");var u=t("<input />");u.attr("type","checkbox"),u.attr("data-ng-model","InputValue"),u.attr("data-ng-change","checkboxChanged()"),o.append(u)}return o.append(r),e(o)(a),o}function p(n,a){void 0!==n.$viewValue&&(a.InputValue=n.$viewValue),n.$formatters.push(function(e){a.InputValue=e}),a.radioChanged=function(){n.$setViewValue("yesNo"===a.ngspColumn.Type?"yes"===a.InputValue?!0:!1:a.InputValue)};var o=t("<span></span>"),r=a.ngspColumn.Title;if("yesNo"===a.ngspColumn.Type){var u=t("<span></span>"),i=t("<input></input>");i.attr("type","radio"),i.attr("data-ng-model","InputValue"),i.attr("data-ng-change","radioChanged()"),i.attr("name",r),i.attr("value","yes"),u.append(i);var l=t("<label></label>");l.text("Yes"),u.append(l);var s=t("<span></span>"),p=t("<input></input>");p.attr("type","radio"),p.attr("data-ng-model","InputValue"),p.attr("data-ng-change","radioChanged()"),p.attr("name",r),p.attr("value","no"),s.append(p);var c=t("<label></label>");c.text("No"),s.append(c),o.append(u),o.append(s)}else if("choice"===a.ngspColumn.Type){var d=t("<span></span>");d.attr("data-ng-repeat","choice in ngspColumn.Choices");var m=t("<input></input>");m.attr("type","radio"),m.attr("data-ng-change","radioChanged()"),m.attr("data-ng-model","$parent.InputValue"),m.attr("name",r),m.attr("value","{{choice}}");var g=t("<label></label>");g.text("{{choice}}"),d.append(m),d.append(g),o.append(d)}else if("lookup"===a.ngspColumn.Type){var f=t("<span></span>");f.attr("data-ng-repeat","lookupItem in ngspColumn.LookupItems");var m=t("<input></input>");m.attr("type","radio"),m.attr("data-ng-change","radioChanged()"),m.attr("data-ng-model","$parent.InputValue"),m.attr("name",r),m.attr("value","{{lookupItem.id}}");var g=t("<label></label>");g.text("{{lookupItem.label}}"),f.append(m),f.append(g),o.append(f)}else{if("metadata"!==a.ngspColumn.Type)return void console.log(a.ngspColumn.Type+"is not supported as a column type for radio input.");var v=t("<span></span>");v.attr("data-ng-repeat","term in ngspColumn.Terms");var m=t("<input></input>");m.attr("type","radio"),m.attr("data-ng-change","radioChanged()"),m.attr("data-ng-model","$parent.InputValue"),m.attr("name",r),m.attr("value","{{term.id}}");var g=t("<label></label>");g.text("{{term.label}}"),v.append(m),v.append(g),o.append(v)}return e(o)(a),o}function c(n,a){void 0!==n.$viewValue&&(a.InputValue={},a.InputValue.Date=n.$viewValue,a.InputValue.Time=n.$viewValue),n.$formatters.push(function(e){a.InputValue={},a.InputValue.Date=e,a.InputValue.Time=e}),a.calendarOpened=!1,a.calendarFormat="yyyy-MM-dd",a.openCalendar=function(e){e.preventDefault(),e.stopPropagation(),a.calendarOpened=!0},a.dateTimeChanged=function(){var e=new Date;void 0!==a.InputValue.Date&&(e.setFullYear(a.InputValue.Date.getFullYear()),e.setMonth(a.InputValue.Date.getMonth()),e.setDate(a.InputValue.Date.getDate())),void 0!==a.InputValue.Time&&(e.setHours(a.InputValue.Time.getHours()),e.setMinutes(a.InputValue.Time.getMinutes())),e.setSeconds(0),n.$setViewValue(e)};var o=t("<span></span>");o.attr("class","input-group");var r=t("<span></span>");r.attr("class","input-group");var u=t("<input />");u.attr("class","form-control"),u.attr("data-ng-model","InputValue.Date"),u.attr("data-datepicker-popup","{{calendarFormat}}"),u.attr("data-is-open","calendarOpened"),u.attr("data-ng-change","dateTimeChanged()"),r.append(u);var i=t("<span></span>");i.attr("class","input-group-btn");var l=t("<button></button>");l.attr("class","btn btn-default"),l.attr("data-ng-click","openCalendar($event)");var s=t("<i></i>");s.attr("class","glyphicon glyphicon-calendar"),l.append(s),i.append(l),r.append(i),o.append(r);var p=t("<timepicker></timepicker>");return p.attr("data-ng-model","InputValue.Time"),p.attr("data-ng-change","dateTimeChanged()"),o.append(p),e(o)(a),o}function d(n,a,o){function r(){var e=u+"_TopSpan",t=SPClientPeoplePicker.SPClientPeoplePickerDict[e];o.InputValue=t.GetAllUserInfo(),a.$setViewValue(o.InputValue)}o.InputValue=void 0!==a.$viewValue?a.$viewValue:null;var u="pp_"+o.ngspColumn.Title+"_"+o.ngspColumn.Id,i=t("<span></span>");i.attr("id",u),e(i)(o);var l={SearchPrincipalSource:15,ResolvePrincipalSource:15,MaximumEntitySuggestions:50,Width:"100%",OnUserResolvedClientScript:r};if(l.Required=o.ngspColumn.IsRequired,l.PrincipalAccountType=o.ngspColumn.PeopleOnly?"User,DL":"User,DL,SecGroup,SPGroup","person"===o.ngspColumn.Type)l.AllowMultipleValues=!1;else{if("multiPerson"!==o.ngspColumn.Type)return void console.log(o.ngspColumn.Type+"is not supported as a column type for people pickers.");l.AllowMultipleValues=!0}return o.$watch(n[0].childNodes.length,function(){var e=t("#"+u);e.length>0&&(SPClientPeoplePicker_InitStandaloneControlWrapper(u,o.InputValue,l),a.$formatters.push(function(e){SPClientPeoplePicker_InitStandaloneControlWrapper(u,e,l)}))}),i}function m(n,a){function o(n,a){a.DisplayValue=n.$viewValue,n.$formatters.push(function(e){a.DisplayValue=e});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function r(n,a){a.InputValue=n.$viewValue,n.$formatters.push(function(e){a.DisplayValue=e});var o=t("<span></span>");return o.attr("data-ng-bind-html","DisplayValue"),e(o)(a),o}function u(n,a){a.InputValue=n.$viewValue,n.$formatters.push(function(e){a.DisplayValue=e});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function i(n,a){n.$formatters.push(function(e){var t=[];for(var n in e)e[n]&&t.push(n);a.DisplayValue=t.join("; ")});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function l(n,a){n.$formatters.push(function(e){a.DisplayValue=a.ngspColumn.LookupItemsById[e].label});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function s(n,a){n.$formatters.push(function(e){var t=[];for(var n in e)if(e[n]){var o=a.ngspColumn.LookupItemsById[n].label;t.push(o)}a.DisplayValue=t.join("; ")});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function p(n,a){n.$formatters.push(function(e){a.DisplayValue=e?"Yes":"No"});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function c(n,a){n.$formatters.push(function(e){var t=[];e.forEach(function(e){t.push(e.AutoFillDisplayText)}),a.DisplayValue=t.join("; ")});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function d(n,a){n.$formatters.push(function(e){a.DisplayValue=a.ngspColumn.TermsById[e].label});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function m(n,a){n.$formatters.push(function(e){var t=[];for(var n in e)if(e[n]){var o=a.ngspColumn.TermsById[n].label;t.push(o)}a.DisplayValue=t.join("; ")});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function g(n,a){n.$formatters.push(function(e){a.DisplayValue=e});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function f(n,a){n.$formatters.push(function(e){a.DisplayValue=e});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function v(n,a){n.$formatters.push(function(e){a.DisplayValue=e});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}function y(n,a){n.$formatters.push(function(e){a.DisplayValue=e});var o=t("<span></span>");return o.text("{{DisplayValue}}"),e(o)(a),o}switch(a.ngspColumn.Type){case"text":return o(n,a);case"multiText":return r(n,a);case"choice":return u(n,a);case"multiChoice":return i(n,a);case"lookup":return l(n,a);case"multiLookup":return s(n,a);case"yesNo":return p(n,a);case"person":case"multiPerson":return c(n,a);case"metadata":return d(n,a);case"multiMetadata":return m(n,a);case"link":return g(n,a);case"number":return f(n,a);case"currency":return v(n,a);case"dateTime":return y(n,a);default:console.log(a.ngspColumn.Type+" is currently unsupported as a column type.")}}return{restrict:"A",require:"ngModel",scope:{ngspColumn:"=",ngspReadOnly:"="},link:n}}function a(n,a){function o(e,t,n,a){e.$watch("ngspList",function(){void 0!==e.ngspList&&(t.html(""),t.append(r(e.ngspList)),t.append(u(a,e)),t.append(l(a,e)))})}function r(e){var n=t("<label></label>");return n.text(e.DisplayName),n}function u(e,t){return i(e,t)}function i(e,a){function o(e){a.gridApi=e,a.gridApi.selection.on.rowSelectionChanged(a,function(){a.selectedRow=a.gridApi.selection.getSelectedRows()[0]})}a.InputValues=void 0!==e.$viewValue?e.$viewValue:[],e.$formatters.push(function(e){console.log(e),void 0!==e&&(a.uiGridOptions.data=e)});var r=[],u=a.ngspList.Columns;for(var i in u)if(u.hasOwnProperty(i)){var l=u[i];if(l.Show){var s={field:i};void 0!==l.DisplayName&&(s.displayName=l.DisplayName),r.push(s)}}a.uiGridOptions={data:a.InputValues,columnDefs:r,enableRowSelection:!0,enableRowHeaderSelection:!1,multiSelect:!1,enableHorizontalScrollbar:1,enableVerticalScrollbar:1,onRegisterApi:o};var p=t("<span></span>"),c=t("<div></div>");return c.attr("data-ui-grid","uiGridOptions"),c.attr("data-ui-grid-selection","true"),c.attr("class","grid"),p.append(c),n(p)(a),p}function l(o,r){r.createRow=function(){var e={},t=a.open({templateUrl:r.ngspTemplateUrl,controller:"listItemModalController",resolve:{item:function(){return e},columns:function(){return r.ngspList.Columns}}});t.result.then(function(e){r.InputValues.push(e),o.$setViewValue(r.InputValues)},function(e){console.log(e)})},r.updateRow=function(){if(void 0===r.selectedRow)alert("Nothing selected.");else{var t=a.open({templateUrl:r.ngspTemplateUrl,controller:"listItemModalController",resolve:{item:function(){return e.copy(r.selectedRow)},columns:function(){return r.ngspList.Columns}}});t.result.then(function(e){var t=r.InputValues.indexOf(r.selectedRow);r.InputValues[t]=e,o.$setViewValue(r.InputValues),r.selectedRow=void 0},function(e){console.log(e)})}},r.deleteRow=function(){if(void 0===r.selectedRow)alert("Nothing selected.");else{var e=r.InputValues.indexOf(r.selectedRow);r.InputValues.splice(e,1),o.$setViewValue(r.InputValues),r.selectedRow=void 0}},r.rowNotSelected=function(){return void 0===r.selectedRow?!0:!1};var u=t("<span></span>"),i=t("<input></input>");i.attr("type","button"),i.attr("value","Add"),i.attr("data-ng-click","createRow()"),u.append(i);var l=t("<input></input>");l.attr("type","button"),l.attr("value","Edit"),l.attr("data-ng-disabled","rowNotSelected()"),l.attr("data-ng-click","updateRow()"),u.append(l);var s=t("<input></input>");return s.attr("type","button"),s.attr("value","Delete"),s.attr("data-ng-disabled","rowNotSelected()"),s.attr("data-ng-click","deleteRow()"),u.append(s),n(u)(r),u}return{restrict:"A",require:"ngModel",scope:{ngspList:"=",ngspReadOnly:"=",ngspTemplateUrl:"@"},link:o}}app.directive("contenteditable",function(){return{restrict:"A",require:"?ngModel",link:function(e,t,n,a){function o(){var e=t.html();a.$setViewValue("<br>"===e?"":e)}a&&(a.$render=function(){t.html(a.$viewValue||"")},t.bind("blur keyup change",function(){e.$apply(o)}))}}}),app.directive("ngspColumn",["$compile",n]),app.directive("ngspList",["$compile","$modal",a])}(angular,jQuery);var app=app||angular.module("angularSP",["ui.bootstrap","ui.grid","ui.grid.selection"]);!function(e,t){function n(n,a,o){function r(){return $}function u(t,o,r){function u(){function e(){function e(){a.forEach(function(e){e.Callback(e.Column,e.RawResults)}),n.listsInfo=j,i.resolve(j)}function t(e,t){i.reject(t.get_message())}$=r.get_serverRelativeUrl();var a=w(j,u);o.executeQueryAsync(e,t)}function a(e,t){i.reject(t.get_message())}var o=SP.ClientContext.get_current(),r=o.get_web();o.load(r,"ServerRelativeUrl");var u=x(t);o.executeQueryAsync(e,a)}L=r,L=o,F=t,R=e.copy(r),O=e.copy(o),j=e.copy(t),h(R,O,j);var i=a.defer();return SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.executeFunc("sp.taxonomy.js","SP.Taxonomy.TaxonomySession",function(){SP.SOD.executeFunc("SP.UserProfiles.js","SP.UserProfiles.PeopleManager",u)})}),i.promise}function i(e,t){function n(){var e=o.DisplayName,n=SP.ClientContext.get_current(),a=n.get_web(),u=a.get_lists().getByTitle(e),i=new SP.ListItemCreationInformation,l=u.addItem(i),s=o.Columns;for(var p in s)if(s.hasOwnProperty(p)){var c=s[p];if(void 0!==t[p]){var d=t[p],m=f(c,d);l.set_item(p,m)}}l.update(),n.load(l),n.executeQueryAsync(function(){r.resolve(l.get_id())},function(e,t){r.reject(t.get_message())})}var o,r=a.defer();return void 0!==j&&void 0!==j[e]&&(o=j[e],SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.executeFunc("sp.taxonomy.js","SP.Taxonomy.TaxonomySession",function(){SP.SOD.executeFunc("SP.UserProfiles.js","SP.UserProfiles.PeopleManager",n)})})),r.promise}function l(e,t){function n(){for(var e=o.DisplayName,n=SP.ClientContext.get_current(),a=n.get_web(),u=a.get_lists().getByTitle(e),i=new SP.ListItemCreationInformation,l=[],s=0;s<t.length;s++){var p=t[s],c=u.addItem(i),d=o.Columns;for(var m in d)if(d.hasOwnProperty(m)){var g=d[m];if(void 0!==p[m]){var v=p[m],y=f(g,v);c.set_item(m,y)}}c.update(),l.push(c),n.load(c)}n.executeQueryAsync(function(){var e=[];l.forEach(function(t){e.push(t.get_id())}),r.resolve(e)},function(e,t){r.reject(t.get_message())})}var o,r=a.defer();return void 0!==j&&void 0!==j[e]&&(o=j[e],SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.executeFunc("sp.taxonomy.js","SP.Taxonomy.TaxonomySession",function(){SP.SOD.executeFunc("SP.UserProfiles.js","SP.UserProfiles.PeopleManager",n)})})),r.promise}function s(e,t){function n(){var e=o.DisplayName,t=SP.ClientContext.get_current(),n=t.get_web(),a=n.get_lists().getByTitle(e),i=a.getItemById(r);t.load(i),t.executeQueryAsync(function(){var e=o.Columns,n=i.get_fieldValues(),a={},r=[];for(var l in e)if(e.hasOwnProperty(l)){var s=e[l];if(void 0!==n[l]){var p=n[l];if(null!==p){var c=v(s,p,r);a[l]=c}}}a.Id=n.ID,r.length>0?t.executeQueryAsync(function(){r.forEach(function(e){e.Callback(e.Values,e.RawResults)}),u.resolve(a)},function(e,t){u.reject(t.get_message())}):u.resolve(a)},function(e,t){u.reject(t.get_message())})}var o,r,u=a.defer();return void 0!==j&&void 0!==j[e]&&(o=j[e],r=t,SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.executeFunc("sp.taxonomy.js","SP.Taxonomy.TaxonomySession",function(){SP.SOD.executeFunc("SP.UserProfiles.js","SP.UserProfiles.PeopleManager",n)})})),u.promise}function p(e,t){function n(){var e=o.DisplayName,t=SP.ClientContext.get_current(),n=t.get_web(),a=n.get_lists().getByTitle(e),i=g(r),l=a.getItems(i);t.load(l),t.executeQueryAsync(function(){for(var e=l.getEnumerator(),n=[],a=[];e.moveNext();){var r=e.get_current(),i=o.Columns,s=r.get_fieldValues(),p={};for(var c in i)if(i.hasOwnProperty(c)){var d=i[c];if(void 0!==s[c]){var m=s[c];if(null!==m){var g=v(d,m,n);p[c]=g}}}p.Id=s.ID,a.push(p)}n.length>0?t.executeQueryAsync(function(){n.forEach(function(e){e.Callback(e.Values,e.RawResults)}),u.resolve(a)},function(e,t){u.reject(t.get_message())}):u.resolve(a)},function(e,t){u.reject(t.get_message())})}var o,r,u=a.defer();return void 0!==j&&void 0!==j[e]&&(o=j[e],r=t,SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.executeFunc("sp.taxonomy.js","SP.Taxonomy.TaxonomySession",function(){SP.SOD.executeFunc("SP.UserProfiles.js","SP.UserProfiles.PeopleManager",n)})})),u.promise}function c(e,t,n){function o(){function e(){var e=r.Columns;for(var n in e)if(e.hasOwnProperty(n)){var a=e[n];if(void 0!==t[n]){var i=t[n],l=f(a,i);s.set_item(n,l)}}s.update(),o.load(s),o.executeQueryAsync(function(){u.resolve(s.get_id())},function(e,t){u.reject(t.get_message())})}var a=r.DisplayName,o=SP.ClientContext.get_current(),i=o.get_web(),l=i.get_lists().getByTitle(a),s=(new SP.ListItemCreationInformation,l.getItemById(t.Id));n?(o.load(s),o.executeQueryAsync(e,function(e,t){u.reject(t.get_message())})):e()}var r,u=a.defer();return void 0!==j&&void 0!==j[e]&&(r=j[e],SP.SOD.executeFunc("sp.js","SP.ClientContext",function(){SP.SOD.executeFunc("sp.taxonomy.js","SP.Taxonomy.TaxonomySession",function(){SP.SOD.executeFunc("SP.UserProfiles.js","SP.UserProfiles.PeopleManager",o)})})),updateDeferrred.promise}function d(e,t,n){function o(e){function t(e,t){for(var n in e)if(e.hasOwnProperty(n)){var a=e[n];if(void 0!==m[n]){var o=m[n],r=f(a,o);t.set_item(n,r)}}}function a(){commitDeferred.resolve()}function o(e,t){commitDeferred.reject(t.get_message())}for(var r=u.DisplayName,i=SP.ClientContext.get_current(),l=i.get_web(),s=l.get_lists().getByTitle(r),p=new SP.ListItemCreationInformation,c=u.Columns,d=n.length-1;d>=0;d--){var m=n[d];if(void 0===m.Id){var g=s.addItem(p);t(c,g),g.update(),i.load(g),n.splice(d,1)}}e.forEach(function(e){for(var a=!1,o=0;o<n.length;o++){var r=n[o];if(e.Id===r.Id){t(columnd,e),e.update(),i.load(e),a=!0;break}}a||e.deleteObject()}),i.executeQueryAsync(a,o)}function r(e){commitDeferred.reject(e)}commitDeferred=a.defer();var u;if(void 0!==j&&void 0!==j[e]){u=j[e];var i=p(e,t);i.then(o,r)}return commitDeferred.promise}function m(e,t){function n(){r.resolve()}function o(e,t){r.reject(t.get_message())}var r=a.defer();if(void 0!==j&&void 0!==j[e]&&void 0!==j[e].DisplayName){var u=j[e].DisplayName,i=SP.ClientContext.get_current(),l=i.get_web(),s=l.get_lists().getByTitle(u),p=s.getItemById(t);p.deleteObject(),i.executeQueryAsync(n,o)}else r.reject("Factory not initialized.");return r.promise}function g(e){var n=new SP.CamlQuery,a=t("<View></View>"),o=t("<Query></Query>"),r=t("<Where></Where>");if(void 0!==e.LookupColumn&&void 0!==e.LookupValue){var u=(t("<Eq></Eq>"),t("<FieldRef />"));u.attr("Name",e.LookupColumn),r.append(u);var i=t("<Value></Value>");i.attr("Type","Lookup"),i.text(e.LookupValue),r.append(i)}o.append(r),a.append(o);var l=a[0].outerHTML;return n.set_viewXml(l),n}function f(e,t){var n=null;switch(e.Type){case"text":case"choice":case"multiText":case"link":case"number":case"currency":n=t;break;case"multiChoice":n=[];for(var a in t)t.hasOwnProperty(a)&&t[a]&&n.push(a);break;case"lookup":n=new SP.FieldLookupValue,n.set_lookupId(t);break;case"multiLookup":n=[];for(var a in t)if(t.hasOwnProperty(a)&&t[a]){var o=new SP.FieldLookupValue;o.set_lookupId(a),n.push(o)}break;case"yesNo":n=t?1:0;break;case"person":if(1===t.length){var r=t[0];n=SP.FieldUserValue.fromUser(r.Key)}else 0!==t.length;break;case"multiPerson":n=[];for(var u=0;u<t.length;u++){var r=t[u];n.push(SP.FieldUserValue.fromUser(r.Key))}break;case"metadata":var i=e.TermsById[t];n=i.label+"|"+i.id;break;case"multiMetadata":var l=[];for(var a in t)if(t.hasOwnProperty(a)&&t[a]){var i=e.TermsById[a];l.push("-1"),l.push(i.label+"|"+i.id)}n=l.join(";#");break;case"dateTime":n=t.toISOString()}return n}function v(e,t,n){var a;switch(e.Type){case"text":case"choice":case"multiText":case"link":case"number":case"currency":a=t;break;case"multiChoice":a={};for(var o=0;o<t.length;o++){var r=t[o];a[r]=!0}break;case"lookup":a=t.get_lookupId();break;case"multiLookup":a={};for(var o=0;o<t.length;o++){var r=t[o].get_lookupId();a[r]=!0}break;case"yesNo":a=1===t?!0:!1;break;case"person":a=[];var u=SP.ClientContext.get_current(),i=u.get_web(),l=i.getUserById(t.get_lookupId());u.load(l),n.push({Values:a,RawResults:l,Callback:y});break;case"multiPerson":a=[];for(var u=SP.ClientContext.get_current(),i=u.get_web(),s=[],o=0;o<t.length;o++){var l=i.getUserById(t[o].get_lookupId());u.load(l),s.push(l)}n.push({Values:a,RawResults:s,Callback:y});break;case"metadata":a=t.get_termGuid();break;case"multiMetadata":a={};for(var o=0;o<t.get_count();o++){var r=t.getItemAtIndex(o);a[r.get_termGuid()]=!0}break;case"dateTime":a=new Date(t)}return a}function y(e,t){function n(t){var n={AutoFillDisplayText:t.get_title(),AutoFillKey:t.get_loginName(),Description:t.get_email(),DisplayText:t.get_title(),EntityType:"User",IsResolved:!0,Key:t.get_loginName(),Resolved:!0};e.push(n)}t.length>0?t.forEach(n):null!==t&&n(t)}function h(e,t,n){I(e,n)}function I(e,t){for(var n in t)if(t.hasOwnProperty(n)){var a=t[n].Columns;void 0!==a&&C(e,a)}}function C(e,t){for(var n in t)if(t.hasOwnProperty(n)){var a=t[n],o=e[n];void 0!==o&&T(o,a)}}function T(e,t){for(var n in e)e.hasOwnProperty(n)&&void 0===t[n]&&(t[n]=e[n])}function V(e,t,n,a){var r=SP.ClientContext.get_current();switch(e.Title=t.get_title(),e.Id=t.get_id().toString(),e.IsRequired=t.get_required(),e.SchemaXml=t.get_schemaXml(),e.DefaultValue=t.get_defaultValue(),e.Scope=t.get_scope(),e.FieldType=t.get_fieldTypeKind(),e.Type){case"text":2===e.FieldType?void 0===e.InputType&&(e.InputType="text"):o.error(t.get_title()+": column type mismatch.");break;case"multiText":if(3===e.FieldType){var u=r.castTo(t,SP.FieldMultiLineText);e.IsRichText=u.get_richText(),void 0===e.InputType&&(e.InputType=e.IsRichText?"nicEdit":"textBox")}else o.error(t.get_title()+": column type mismatch.");break;case"choice":if(6===e.FieldType){void 0===e.InputType&&(e.InputType="dropDown");var i=r.castTo(t,SP.FieldChoice);e.Choices=i.get_choices(),e.FillInChoice=i.get_fillInChoice(),e.EditFormat=i.get_editFormat()}else o.error(t.get_title()+": column type mismatch.");break;case"multiChoice":if(15===e.FieldType){void 0===e.InputType&&(e.InputType="checkbox");var l=r.castTo(t,SP.FieldMultiChoice);e.Choices=l.get_choices(),e.FillInChoice=l.get_fillInChoice()}else o.error(t.get_title()+": column type mismatch.");break;case"lookup":if(7===e.FieldType){void 0===e.InputType&&(e.InputType="dropDown");var s=r.castTo(t,SP.FieldLookup),p=s.get_allowMultipleValues();if(p)o.error(t.get_title()+": column type mismatch.");else{e.LookupField=s.get_lookupField(),e.LookupList=s.get_lookupList();var c=P(e);n.push({Column:e,RawResults:c,Callback:b}),a++}}else o.error(t.get_title()+": column type mismatch.");break;case"multiLookup":if(7===e.FieldType){void 0===e.InputType&&(e.InputType="checkbox");var s=r.castTo(t,SP.FieldLookup),p=s.get_allowMultipleValues();if(p){e.LookupField=s.get_lookupField(),e.LookupList=s.get_lookupList();var c=P(e);n.push({Column:e,RawResults:c,Callback:b}),a++}else o.error(t.get_title()+": column type mismatch.")}else o.error(t.get_title()+": column type mismatch.");break;case"yesNo":8===e.FieldType?void 0===e.InputType&&(e.InputType="checkbox"):o.error(t.get_title()+": column type mismatch.");break;case"person":if(20===e.FieldType){void 0===e.InputType&&(e.InputType="peoplePicker");var d=r.castTo(t,SP.FieldUser);e.SelectionGroup=d.get_selectionGroup(),e.PeopleOnly=0===d.get_selectionMode();var m=d.get_allowMultipleValues();m?o.error(t.get_title()+": column type mismatch."):a++}else o.error(t.get_title()+": column type mismatch.");break;case"multiPerson":if(20===e.FieldType){void 0===e.InputType&&(e.InputType="peoplePicker");var d=r.castTo(t,SP.FieldUser);e.SelectionGroup=d.get_selectionGroup(),e.PeopleOnly=0===d.get_selectionMode();var m=d.get_allowMultipleValues();m?a++:o.error(t.get_title()+": column type mismatch.")}else o.error(t.get_title()+": column type mismatch.");break;case"metadata":if(0===e.FieldType){void 0===e.InputType&&(e.InputType="dropDown");var g=D(e);if("TaxonomyFieldType"===g){var f=k(e);n.push({Column:e,RawResults:f,Callback:_}),a++}else o.error(t.get_title()+": column type mismatch.")}else o.error(t.get_title()+": column type mismatch.");break;case"multiMetadata":if(0===e.FieldType){void 0===e.InputType&&(e.InputType="checkbox");var g=D(e);if("TaxonomyFieldTypeMulti"===g){var f=k(e);n.push({Column:e,RawResults:f,Callback:_}),a++}else o.error(t.get_title()+": column type mismatch.")}else o.error(t.get_title()+": column type mismatch.");break;case"link":11===e.FieldType?void 0===e.InputType&&(e.InputType="text"):o.error(t.get_title()+": column type mismatch.");break;case"number":9===e.FieldType?void 0===e.InputType&&(e.InputType="text"):o.error(t.get_title()+": column type mismatch.");break;case"currency":10===e.FieldType?void 0===e.InputType&&(e.InputType="text"):o.error(t.get_title()+": column type mismatch.");break;case"dateTime":4===e.FieldType?void 0===e.InputType&&(e.InputType="dateTime"):o.error(t.get_title()+": column type mismatch.")}return a}function x(e){var t=[],n=SP.ClientContext.get_current(),a=n.get_web();for(var o in e)if(e.hasOwnProperty(o)){var r=e[o],u=o;void 0!==r.DisplayName&&(u=r.DisplayName);var i=a.get_lists().getByTitle(u);void 0!==r.Columns&&S(n,i,r.Columns,t)}return t}function S(e,t,n,a){var o=t.get_fields();for(var r in n)if(n.hasOwnProperty(r)){var u=o.getByInternalNameOrTitle(r);e.load(u),a.push(u)}}function P(e){var t=new SP.CamlQuery,n=SP.ClientContext.get_current(),a=n.get_web(),o=a.get_lists().getById(e.LookupList),r=o.getItems(t);return n.load(r),r}function k(e){var t=SP.ClientContext.get_current(),n=SP.Taxonomy.TaxonomySession.getTaxonomySession(t),a=n.get_termStores(),o=a.getById(e.SspId),r=o.getTermSet(e.TermSetId),u=r.getAllTerms();return t.load(u),u}function b(e,t){e.LookupItems=[],e.LookupItemsById={},e.LookupItemsByLabel={};for(var n=t.getEnumerator();n.moveNext();){var a=n.get_current(),o=a.get_fieldValues(),r=o.ID,u=o[e.LookupField],i={id:r,label:u};e.LookupItems.push(i),e.LookupItemsById[r]=i,e.LookupItemsByLabel[u]=i}}function _(e,t){e.Terms=[],e.TermsById={},e.TermsByLabel={};for(var n=t.getEnumerator();n.moveNext();){var a=n.get_current(),o=a.get_id().toString(),r=a.get_name(),u={id:o,label:r};e.Terms.push(u),e.TermsById[o]=u,e.TermsByLabel[r]=u}}function w(e,t){for(var n=[],a=0;a<t.length;a++){var o=t[a],r=o.get_internalName(),u=o.get_scope(),i=u.split("/").pop(),l=e[i];if(void 0!==l&&void 0!==l.Columns){var s=l.Columns[r];void 0===l.LookupCount&&(l.LookupCount=0),l.LookupCount=V(s,o,n,l.LookupCount)}}return n}function D(e){var n=t.parseXML(e.SchemaXml),a=t(n),o=a.find("Field"),r="";void 0!==o&&(r=o.attr("Type"));for(var u=a.find("Property"),i=0;i<u.length;i++){var l=void 0===u[i].firstChild.textContent?u[i].firstChild.text:u[i].firstChild.textContent,s=void 0===u[i].lastChild.textContent?u[i].lastChild.text:u[i].lastChild.textContent;if(l!==s)switch(l){case"SspId":e.SspId=s;break;case"GroupId":e.GroupId=s;break;case"TermSetId":e.TermSetId=s}}return r}var $,L,F,R,O,j,M={initFactory:u,createListItem:i,createListItems:l,getListItem:s,getListItems:p,updateListItem:c,deleteListItem:m,commitListItems:d,getServerRelativeUrl:r};return M}app.factory("spListFactory",["$rootScope","$q","$log",n])}(angular,jQuery);var app=app||angular.module("angularSP",["ui.bootstrap","ui.grid","ui.grid.selection"]);!function(){function e(e,t,n,a){e.item=n,e.columns=a,e.submit=function(e){t.close(e)},e.cancel=function(){t.dismiss("Canceled.")}}app.controller("listItemModalController",["$scope","$modalInstance","item","columns",e])}(angular,jQuery);